/*!
 * @version 0.1.0
 * @date 2018-03-20
 */
!function(t,e){"object"===typeof exports&&"object"===typeof module?module.exports=e():"function"===typeof define&&define.amd?define([],e):"object"===typeof exports?exports["js-infinite-scroller"]=e():t["js-infinite-scroller"]=e()}("undefined"!==typeof self?self:this,function(){return function(t){var e={};function i(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:s})},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s=function(){function t(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}}();var n=function(){function t(e,i,s){if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),!e||!i)throw new Error("\u7f3a\u4e4f\u5fc5\u8981\u53c2\u6570");s=s||{},this.listMarginTop=s.listMarginTop||this.getOffsetTop(e),this.runwayItems=s.runwayItems||10,this.runwayItemsOpposite=s.runwayItemsOpposite||10,this.collectBottomDOMFlag=s.collectBottomDOMFlag||!0,this.reusingSelector=s.reusingSelector||"",this._scroller=e,this._source=i,this._init()}return s(t,[{key:"_init",value:function(){this.anchorItem={index:0,offset:0},this.firstAttachedItemIndex=0,this.lastAttachedItemIndex=0,this.firstScreenItemIndex=0,this.lastScreenItemIndex=0,this.anchorScrollTop=0,this._tombstoneSize=40,this._items=[],this._loadedItems=0,this._requestInProgress=!1,this._scrollRunwayEnd=0,window.addEventListener("scroll",this._onScroll.bind(this)),this._onResize()}},{key:"_onResize",value:function(){for(var t=0;t<this._items.length;t++)this._items[t].height=this._items[t].width=0;this._onScroll()}},{key:"_onScroll",value:function(){var t=window.scrollY-this.listMarginTop,e=window.screen.height;t<0&&(e+=t,t=0);var i=t-this.anchorScrollTop;this.anchorItem=0==t?{index:0,offset:0}:this._calculateAnchoredItem(this.anchorItem,i),this.anchorScrollTop=t;var s=this._calculateAnchoredItem(this.anchorItem,e);this.firstScreenItemIndex=this.anchorItem.index,this.lastScreenItemIndex=s.index,i<0?(this.collectBottomDOMFlag=!0,this._fill(this.anchorItem.index-this.runwayItems,s.index+this.runwayItemsOpposite)):this._fill(this.anchorItem.index-this.runwayItemsOpposite,s.index+this.runwayItems)}},{key:"_calculateAnchoredItem",value:function(t,e){if(0==e)return t;e+=t.offset;var i=t.index,s=0;if(e<0){for(;e<0&&i>0&&this._items[i-1].height;)e+=this._items[i-1].height,i--;s=Math.max(-i,Math.ceil(Math.min(e,0)/this._tombstoneSize))}else{for(;e>0&&i<this._items.length&&this._items[i].height&&this._items[i].height<e;)e-=this._items[i].height,i++;(i>=this._items.length||!this._items[i].height)&&(s=Math.floor(Math.max(e,0)/this._tombstoneSize))}return{index:i+=s,offset:e-=s*this._tombstoneSize}}},{key:"_fill",value:function(t,e){this.firstAttachedItemIndex=Math.max(0,t),this.lastAttachedItemIndex=e,this._attachContent()}},{key:"_chreatDOM",value:function(t,e){if(!this._items[e].node){var i=null;if(this.reusingSelector){var s=this._items[e].data&&this._items[e].data[this.reusingSelector];t[s]&&t[s].length&&(i=t[s].pop())}var n=this._source.render(this._items[e].data,i);n.style.position="absolute",this._items[e].top=-1,this._scroller.appendChild(n),this._items[e].node=n}}},{key:"_attachContent",value:function(t){var e={__defaultDOMResuingNodeType:[]};for(n=0;n<this._items.length;n++)if(n!=this.firstAttachedItemIndex){if(this._items[n].node)if(this.reusingSelector&&this._items[n].data[this.reusingSelector]){var i=this._items[n].data[this.reusingSelector];"[object Array]"===Object.prototype.toString.call(e[i])?e[i].push(this._items[n].node):e[i]=[this._items[n].node]}else e.__defaultDOMResuingNodeType.push(this._items[n].node);this._items[n].node=null}else n=this.lastAttachedItemIndex-1,this.collectBottomDOMFlag||(n=this._items.length);var s="fetch"===t?this._loadedItems:this.lastAttachedItemIndex;for(n=this.firstAttachedItemIndex;n<s;n++){if(n>=this._loadedItems){n=s;break}this._chreatDOM(e,n)}for(var n in e)for(;e[n].length;)this._scroller.removeChild(e[n].pop());for(e=null,n=this.firstAttachedItemIndex;n<s&&!(n>=this._loadedItems);n++)this._items[n].data&&!this._items[n].height&&(this._items[n].height=this._items[n].node.offsetHeight,this._items[n].width=this._items[n].node.offsetWidth);for(this.anchorScrollTop=0,n=0;n<this.anchorItem.index;n++)this.anchorScrollTop+=this._items[n].height||this._tombstoneSize;this.anchorScrollTop+=this.anchorItem.offset;var o=this.anchorScrollTop-this.anchorItem.offset;for(n=this.anchorItem.index;n>this.firstAttachedItemIndex;)o-=this._items[n-1].height||this._tombstoneSize,n--;for(;n<this.firstAttachedItemIndex;)o+=this._items[n].height||this._tombstoneSize,n++;for(n=this.firstAttachedItemIndex;n<s;n++){if(n>=this._loadedItems){n=s;break}o!=this._items[n].top&&(this._items[n].node.style.transform="translateY("+o+"px)"),this._items[n].top=o,o+=this._items[n].height||this._tombstoneSize}this._scrollRunwayEnd=Math.max(this._scrollRunwayEnd,o),this._scroller.style.height=this._scrollRunwayEnd+"px",this._maybeRequestContent()}},{key:"_maybeRequestContent",value:function(){var t=this;if(!this._requestInProgress){var e=this.lastAttachedItemIndex-this._loadedItems;e<=0||(this._requestInProgress=!0,this._source.fetch(e).then(function(e){e.length&&t._addContent(e)}))}}},{key:"_addItem",value:function(){this._items.push({data:null,node:null,height:0,width:0,top:0})}},{key:"_addContent",value:function(t){this._requestInProgress=!1,this.collectBottomDOMFlag=!1;for(var e=0;e<t.length;e++){this._items.length<=this._loadedItems&&this._addItem();var i=this._loadedItems;this._items[i].data=t[e],t[e].__InfiniteScrollerIndex=i,this._loadedItems++}this._attachContent("fetch")}},{key:"_updateContentPos",value:function(t,e,i){for(var s=t;s<e;s++)this._items[s].top=this._items[s].top+i,this._items[s].node&&(this._items[s].node.style.transform="translateY("+this._items[s].top+"px)")}},{key:"getOffsetTop",value:function(t){for(var e=t.offsetTop,i=t.offsetParent;null!=i;)e+=i.offsetTop,i=i.offsetParent;return e}},{key:"resizeList",value:function(t){t=parseInt(t,10),this.listMarginTop=t===t?t:this.getOffsetTop(this._scroller)}},{key:"resizeContent",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.itemIndex,i=t.info,s=void 0===i?{}:i,n=t.newHeight;if(null!=e||null!=s.key&&null!=s.value)if(null!=e?e=parseInt(e,10):this._items.forEach(function(t,i){t.data[s.key]!==s.value||(e=i)}),this._items[e]){var o=this._items.length;if(n){var h=n-this._items[e].height;this._items[e].height=n,this._updateContentPos(e+1,o,h)}}else console.warn("resizeContent\u6ca1\u6709\u627e\u5230\u5bf9\u5e94\u8282\u70b9");else console.warn("resizeContent\u7f3a\u4e4f\u5fc5\u5907\u66f4\u65b0\u4fe1\u606f")}}]),t}();e.default=n}])});